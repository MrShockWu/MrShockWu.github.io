<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />
    <meta name="renderer" content="ie-comp" />
    <!-- 360浏览器优先使用兼容模式 -->
    <title>影像</title>

    <link rel="stylesheet" type="text/css" href="../theme/theme-indigo.css">
    <link rel="stylesheet" type="text/css" href="../layout/css/layout-indigo.css">
    <link rel="stylesheet" type="text/css" href="primeng.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        html,
        body {
            height: 100%;
            text-align: center;
            font: 12px/1.4 Verdana, sans-serif
        }

        .wrapper {
            width: 100%;
            min-height: 100%;
            margin: auto;
            text-align: center;
            height: 100%
        }

        .left {
            width: 8%;
            height: 100%;
            float: left;
            left: 0;
            min-height: 100%;
            text-align: left;
        }

        .right {
            width: 92%;
            height: 100%;
            float: right;
            left: 0;
            min-height: 100%;
        }

        ul,
        ol,
        dl,
        li {
            list-style: none;
        }

        a {
            color: #5789bb;
            text-decoration: none;
            width: 100%;
            margin: auto 0;
            padding: auto 0;
        }

        a:hover,
        a:active,
        a:focus {
            color: #009bdf;
            text-decoration: none;
        }

        .nav ul {
            padding-left: 0;
            margin: 1px 0 7px 0;
            width: 100%;
            font-size: 1em;
            float: left;
        }

        .nav ul li {
            vertical-align: center;
        }

        .nav ul li a {
            padding: 2px 0 2px 10px;
            color: black;
            text-decoration: none;
            float: left;
        }

        .nav ul li a:hover {
            background-color: #5789bb;
            color: #fff;
        }

        .nav ul .active a {
            background-color: #5789bb;
            color: #fff;
        }

        .content {
            height: 100%;
        }

        iframe {
            padding: 2em;
        }

        .tree-node-open {
            /* background-image: url(../images/folder-open.gif); */
        }

        .tree-node-close {
            /* background-image: url(../images/folder.gif); */
        }
    </style>
    <script type="text/javascript" src="./jquery.min.js"></script>
</head>

<body>
    <div class="wrapper">
        <div class="left">
            <div id="main_show">
                <div class="x-panel-header x-unselectable" id="picishuxing" style="mozuserselect: none; khtmluserselect: none;text-align:center;"
                    unselectable="on">
                    <span id="ext-gen199">菜单</span>
                </div>

                <div class="nav">
                    <ul class="navlist">
                        <li class="active">
                            <a href="javascript:void(0);" data="APP1001">
                                <img src="../layout/images/field.png" />&nbsp;客户资料</a>
                        </li>
                        <li>
                            <a href="javascript:void(0);" data="APP1009-20">
                                <img src="../layout/images/field.png" />&nbsp;存贷款挂接</a>
                        </li>
                        <li>
                            <a href="javascript:void(0);" data="APP1009-21">
                                <img src="../layout/images/field.png" />&nbsp;账户开立</a>
                        </li>
                        <li>
                            <a href="javascript:void(0);" data="APP1009-22">
                                <img src="../layout/images/field.png" />&nbsp;客户凭证接收</a>
                        </li>
                        <li>
                            <a href="javascript:void(0);" data="APP1009-23">
                                <img src="../layout/images/field.png" />&nbsp;代缴费签约</a>
                        </li>
                        <li>
                            <a href="javascript:void(0);" data="APP1009-24">
                                <img src="../layout/images/field.png" />&nbsp;信用卡业务</a>
                        </li>
                        <li>
                            <a href="javascript:void(0);" data="APP1009-25">
                                <img src="../layout/images/field.png" />&nbsp;网银签约</a>
                        </li>
                        <li>
                            <a href="javascript:void(0);" data="APP1009-26">
                                <img src="../layout/images/field.png" />&nbsp;方付通签约</a>
                        </li>
                        <li>
                            <a href="javascript:void(0);" data="APP1009-26">
                                <img src="../layout/images/field.png" />&nbsp;智多薪签约</a>
                        </li>
                        <li>
                            <a href="javascript:void(0);" data="APP1009-27">
                                <img src="../layout/images/field.png" />&nbsp;综合交易</a>
                        </li>
                        <li>
                            <a href="javascript:void(0);" data="APP1009-28,37">
                                <img src="../layout/images/field.png" />&nbsp;现场签约</a>
                        </li>
                        <li>
                            <a href="javascript:void(0);" data="APP1009-29">
                                <img src="../layout/images/field.png" />&nbsp;工作日程</a>
                        </li>
                        <li>
                            <a href="javascript:void(0);" data="APP1009-30,34">
                                <img src="../layout/images/field.png" />&nbsp;客户信息修改申请</a>
                        </li>
                        <li>
                            <a href="javascript:void(0);" data="APP1009-36">
                                <img src="../layout/images/field.png" />&nbsp;征信授权</a>
                        </li>
                        <li>
                            <a href="javascript:void(0);" data="APP1009-18">
                                <img src="../layout/images/field.png" />&nbsp;现场调查信息</a>
                        </li>
                        <li>
                            <a href="javascript:void(0);" data="APP1009-39">
                                <img src="../layout/images/field.png" />&nbsp;影像补录</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="right">
            <form action="" method="post" id="form" target="iframe" style="height:0;">
                <input type="hidden" name="UID" value="crm" style="width: 350px;" />
                <!-- 姓名：平台为对接系统提供的用户<br/> -->
                <input type="hidden" name="PWD" value="crm" style="width: 350px;" />
                <!-- 密码：平尾对接系统提供的密码<br/> -->
                <input type="hidden" name="AppID" value="SA" style="width: 350px;" />
                <!-- 业务应用号：平台为对接系统提供的业务应用号,目前为PA和AA<br/> -->
                <!-- <input type="hidden" id="UserName" name="UserName" style="width: 350px;" [value]="userName" /> -->
                <!-- 操作人姓名：该笔业务的操作人姓名<br/> -->
                <!-- <input type="hidden" id="UserID" name="UserID" style="width: 350px;" [value]="userID" /> -->
                <!-- 操作人代号：该笔业务的操作人代号<br/> -->
                <!-- infoBUSI_SERIAL_NO:WANGZZJJJGGGGHJJHKJJKHJHJHHHJZZZ;OBJECT_NAME:CUST_INFO;QUERY_TIME:20101229 -->

                <!-- 机构 -->
                <!-- <input type="hidden" id="OrgId" name="OrgID" style="width: 350px;" [value]="OrgId" /> -->
                <!-- 影像平台机构信息：因机构对应缓存所在地，所以需要保证所有接入系统的机构号是相同的，如外接系统和平台机构号不相同，则应建立对应关系
                                             <br/> -->
                <!-- <input type="hidden" id="OrgName" name="OrgName" style="width: 350px;" [value]="OrgName" /> -->
                <!-- 影像平台机构名称：机构所对应的名称<br/> -->

                <!-- 权限 -->
                <input type="hidden" id="right" name="right" style="width: 350px;" value="1111111" />
                <!-- 影像平台权限代码：影像平台对文件的操作权限
                                             <br/> -->
                <!-- 
                                             <input type="hidden" name="fileLevel" value="<%= fileLevel%>" class="" style="width: 350px;" />
                                             <input type="hidden" name="fileLeve2" value="" class="" style="width: 350px;" />
                                              -->
                <!-- 1．等级需要完全匹配，可传多个等级  2.参数格式:1,2,3,4,5,6... 3.如果不需要分级此参数可以为空<br/> -->
                <input type="hidden" id="OrgOwner" name="OrgOwner" style="width: 350px;" value="CRM" />
                <br/>

                <!-- <input type="submit" value="提交"/> -->
                <!-- <input type="button" value="申请令牌" onclick="javascript:applyToken()"/> -->
            </form>

            <div class="content">
                <iframe name="iframe" id="ifrmid" align="left" frameborder="0" width="100%" height="100%" scrolling="yes"></iframe>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        var session = getCookie('session'); //获取cookie
        console.log(session);
        var custNo = session.custNo;
        var userMesg = session.commonHeader;
        var userName = session.userName;
        var BANK_FLAG;
        if (userMesg.targetId.charAt(userMesg.targetId.length - 1) == '0') { //台行
            BANK_FLAG = 'tzb';
        } else {
            BANK_FLAG = 'czb';
        }
        var ImgTokenIp = '10.1.97.166';
        var ImgTokenPort = '9081';
        var url = 'http://10.1.97.166:9081/SunIAS_V7/SunIASRequestServlet.do';
        var userID = userMesg.userId;
        var OrgId = userMesg.orgId;
        var OrgName;

        var list;
        var imgToken;
        var object_name;
        var file_level;
        var custType;
        var idenNum;
        var fileLevel1;
        var timeDate = new Date();

        /**
         * 获取cookie
         */
        function getCookie(name) {
            var arr, reg = new RegExp("(^|)" + name + "=([^;]*)(;|$)");
            if (arr = document.cookie.match(reg)) {
                return JSON.parse(arr[2]);
            } else {
                return null;
            }
        }

        /**
         * 获取时间年月日(格式为YYYYMMDD)
         */
        function transDate(value) {
            var year = value.getFullYear();
            var month = value.getMonth() + 1 + '';
            var data = value.getDate() + '';
            if (month.length < 2) {
                month = '0' + month;
            }
            if (data.length < 2) {
                data = '0' + data
            }
            var time = year + '' + month + '' + data;
            return time;
        }

        /**
         * 获取时间时分秒毫秒(格式为HHmmssSSS)
         */
        function transDate2(value) {
            var hour = value.getHours();
            var minute = value.getMinutes();
            var second = value.getSeconds();
            var millisecond = value.getMilliseconds();
            if (hour.length < 2) {
                hour = '0' + hour;
            }
            if (minute.length < 2) {
                minute = '0' + minute;
            }
            if (second.length < 2) {
                second = '0' + second;
            }
            switch (millisecond.length) {
                case 1:
                    millisecond = '00' + millisecond;
                    break;
                case 2:
                    millisecond = '0' + millisecond;
                    break;
            }
            var time = hour + '' + minute + '' + second + '' + millisecond;
            return time;
        }

        /**
         * 公共报文
         */
        function handleParams(params) {
            // debugger
            var commonHeader = {};
            // if (session.getItem('para')) {
            //     userMesg1 = JSON.parse(atob(session.getItem('para')));
            //     if (userMesg1['taskCategoryId'] || userMesg1['scheduleId']) {
            //         commonHeader['taskCategoryId'] = userMesg1['taskCategoryId'];
            //         commonHeader['scheduleId'] = userMesg1['scheduleId'];
            //     }
            // }
            var timeStamp = timeDate.getTime(); //时间戳
            commonHeader['timeStamp'] = timeStamp + ''; //跳转url
            var url = window.location.hash;
            if (url.indexOf('#/pages/tzb') != -1) {
                url = url.slice(url.indexOf('#') + 12, url.length);
            } else if (url.indexOf('#/pages')) {
                url = url.slice(url.indexOf('#') + 8, url.length)
            }
            commonHeader['jumpPath'] = url + ''; //工作流
            commonHeader['comSERVICE_CODE'] = params['comSERVICE_CODE'];
            commonHeader['comMESSAGE_CODE'] = params['comMESSAGE_CODE'];
            if (params && (params['taskCategoryId'] || params['scheduleId'])) {
                commonHeader['taskCategoryId'] = params['taskCategoryId'];
                commonHeader['scheduleId'] = params['scheduleId'];
            }
            commonHeader['globalSeqNo'] = userMesg['globalSeqNo']
            if (userMesg['extParam']) {
                commonHeader['extParam'] = userMesg['extParam']
            }
            if (userMesg['departmentId']) {
                commonHeader['departmentId'] = userMesg['departmentId']
            } else {
                commonHeader['departmentId'] = '';
            }
            commonHeader['tranDate'] = transDate(timeDate);
            commonHeader['tranTime'] = transDate2(timeDate);
            commonHeader['lastTimeZone'] = userMesg['lastTimeZone'];
            commonHeader['userId'] = userMesg['userId'];
            commonHeader['orgId'] = userMesg['orgId'];
            commonHeader['userRoles'] = userMesg['userRoles'];
            commonHeader['targetId'] = userMesg['targetId']; //前后台联动
            if (userMesg['scheduleId'] || userMesg['taskCategoryId']) {
                commonHeader['taskCategoryId'] = userMesg['taskCategoryId'];
                commonHeader['scheduleId'] = userMesg['scheduleId'];
            }
            params['commonHeader'] = commonHeader;
            return params;
        }

        /**
         * esb 影像流水    http://xwzhuat.tzbtest.ins
         */
        function BZ_1100300008103_MP() {
            var param = handleParams({
                clientNo: custNo
            });
            $.ajax({
                type: 'POST',
                url: 'http://xwzhuat.tzbtest.ins/ywsn/BZ_1100300008103_MP',
                data: JSON.stringify(param),
                async: false,
                headers: {
                    'x-ajax': '1',
                    'Content-Type': 'application/json'
                },
                dataType: 'json',
                success: function (data) {
                    if (data.returnCode.code == 'success') {
                        list = data.infoList;
                    }
                },
                error: function (data) {

                }
            })
        }

        /**
         * 查询Token
         */
        function queryImgToken() {
            var param = handleParams({
                imgTokenIp: ImgTokenIp,
                imgTokenPort: ImgTokenPort,
                userId: userID,
                right: '1111111', //操作权限
                custId: custNo,
            })
            $.ajax({
                type: 'POST',
                url: 'http://xwzhuat.tzbtest.ins/ywsn/queryImgToken',
                data: JSON.stringify(param),
                async: false,
                headers: {
                    'x-ajax': '1',
                    'Content-Type': 'application/json'
                },
                dataType: 'json',
                success: function (data) {
                    if (data.returnCode.code == 'success') {
                        imgToken = data.imgToken;
                    }
                },
                error: function (data) {

                }
            })
        }

        /**
         * 查询客户基本信息
         */
        function selectCustBriefInfo() {
            var param = handleParams({
                custNo: custNo
            })
            $.ajax({
                type: 'POST',
                url: 'http://xwzhuat.tzbtest.ins/ywsn/selectCustBriefInfo',
                data: JSON.stringify(param),
                async: false,
                headers: {
                    'x-ajax': '1',
                    'Content-Type': 'application/json'
                },
                dataType: 'json',
                success: function (data) {
                    if (data.returnCode.code == 'success') {
                        custType = data.custType; //客户类型
                        idenNum = data.idenNum; //证件号码
                    }
                },
                error: function (data) {

                }
            })
        }

        /**
         * 根据orgId查询orgName
         */
        function queryOrgByCombConditionsLevel() {
            var param = handleParams({
                orgId: OrgId
            })
            $.ajax({
                type: 'POST',
                url: 'http://xwzhuat.tzbtest.ins/ywsn/queryOrgByCombConditionsLevel',
                data: JSON.stringify(param),
                async: false,
                headers: {
                    'x-ajax': '1',
                    'Content-Type': 'application/json'
                },
                dataType: 'json',
                success: function (data) {
                    if (data.returnCode.code == 'success') {
                        OrgName = data.orgInfoList[0].orgName;
                        increaseFormNode('OrgName', 'OrgName', OrgName);
                        increaseFormNode('UserName', 'UserName', userName);
                        increaseFormNode('UserID', 'UserID', userID);
                        increaseFormNode('OrgID', 'OrgID', OrgId);
                        formContent = document.forms[0].innerHTML; //存储默认的表单
                        // console.log(document.forms[0]);
                    }
                },
                error: function (data) {

                }
            })
        }

        /**
         * 默认添加DOM
         */
        function increaseFormNode(id, name, value) {
            var inputNode = document.createElement('input');
            inputNode.setAttribute('type', 'hidden');
            inputNode.setAttribute('id', id);
            inputNode.setAttribute('name', name);
            inputNode.setAttribute('value', value);
            document.forms[0].appendChild(inputNode);
        };

        /**
         * 每次点击之后的DOM操作
         */
        function increaseFormNode0() {
            var inputNode = document.createElement('input');
            inputNode.setAttribute('type', 'hidden');
            inputNode.setAttribute('id', 'info1');
            inputNode.setAttribute('name', 'info1');
            inputNode.setAttribute('value',
                'BUSI_SERIAL_NO:' + custNo + ';FILELEVEL:' + file_level + ';RIGHT:1111111;OBJECT_NAME:' +
                object_name + ';QUERY_TIME:' + currDate + ';TOKEN_CODE:' + imgToken + ';'
            );
            document.forms[0].appendChild(inputNode);
        }

        function increaseFormNode1() {
            var inputNode = document.createElement('input');
            inputNode.setAttribute('type', 'hidden');
            inputNode.setAttribute('id', 'info1');
            inputNode.setAttribute('name', 'info1');
            inputNode.setAttribute('value',
                'BUSI_SERIAL_NO:' + idenNum + ';FILELEVEL:' + file_level + ';RIGHT:1111111;OBJECT_NAME:' +
                object_name + ';QUERY_TIME:' + currDate + ';TOKEN_CODE:' + imgToken + ';'
            );
            document.forms[0].appendChild(inputNode);
        }

        function increaseFormNode2(index, IMP_SEQ_NO, fileLevel) {
            var inputNode = document.createElement('input');
            inputNode.setAttribute('type', 'hidden');
            inputNode.setAttribute('id', 'info' + index);
            inputNode.setAttribute('name', 'info' + index);
            inputNode.setAttribute('value',
                'BUSI_SERIAL_NO:' + IMP_SEQ_NO + ';FILELEVEL:' + fileLevel + ';RIGHT:1111111;OBJECT_NAME:' +
                object_name + ';QUERY_TIME:' + currDate + ';TOKEN_CODE:' + imgToken + ';'
            );
            document.forms[0].appendChild(inputNode);
        }

        function increaseFormNode3() {
            var inputNode = document.createElement('input');
            inputNode.setAttribute('type', 'hidden');
            inputNode.setAttribute('id', 'info1');
            inputNode.setAttribute('name', 'info1');
            inputNode.setAttribute('value',
                'CUSTOMER_NO:' + custNo + ';FILELEVEL:' + file_level + ';RIGHT:1111111;OBJECT_NAME:' + object_name +
                ';QUERY_TIME:' + currDate + ';TOKEN_CODE:' + imgToken +
                ';SERIAL_TYPE:;LRRQ_MIN:;LRRQ_MAX:;IMG_TYPE:;BANK_FLAG:' + BANK_FLAG + ';'
            );
            document.forms[0].appendChild(inputNode);
        }

        $(document).ready(function () {
            selectCustBriefInfo();
            BZ_1100300008103_MP();
            queryImgToken();
            queryOrgByCombConditionsLevel();
        })

        $('.navlist li').click(function () {
            $('.navlist li').removeClass('active');
            $(this).addClass('active');

            var data = $('.active a').attr('data'); //当前点击的菜单-数据
            // console.log(data);
            document.forms[0].innerHTML = formContent;
            currDate = transDate(timeDate); //当前时间格式为'YYYYMMDD'

            BUSI_SERIAL_NO_List = []; // 清空
            object_name = data.split('-')[0]; //当前点击
            file_level = data.split('-')[1];
            if (list && list.length != 0) { //过滤流水号(根据当前文件等级)
                list.forEach(function (element) {
                    if (!element.fileLevel || element.fileLevel == '') { //由于PAD接口过来的类型可能为空，这里对空的类型都赋值为41
                        element.fileLevel = '41';
                    } else if (element.fileLevel == file_level) {
                        BUSI_SERIAL_NO_List = BUSI_SERIAL_NO_List.push(element);
                    }
                });
            }

            /**
             * 每次点击之后的操作
             */
            debugger
            if (object_name == 'APP1001') { //如果选中的是客户资料，流水号就是客户ID
                //资料级别
                if (custType != null && custType == '1' && object_name != null && object_name ==
                    'APP1001') {
                    file_level = '11';
                } else if (custType != null && custType == '2' && object_name != null && object_name ==
                    'APP1001') {
                    file_level = '10';
                } else if (custType != null && custType == '1' && object_name != null && object_name ==
                    'APP1002') {
                    file_level = '10';
                } else if (custType != null && custType == '2' && object_name != null && object_name ==
                    'APP1002') {
                    file_level =
                        '11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32';
                }

                increaseFormNode0();
            } else {
                if (BUSI_SERIAL_NO_List.length == 0) { //如果这笔文件等级下没有流水号，默认用证件号码作为流水号
                    file_level = file_level.replace(/36/g, '31');
                    increaseFormNode1();
                } else {
                    var i = 1;
                    BUSI_SERIAL_NO_List.forEach(function (element) {
                        if (element.fileLevel == '36') {
                            increaseFormNode2(i, element.IMP_SEQ_NO, element.fileLevel);
                        } else if (element.fileLevel == '18') {

                        } else {
                            increaseFormNode2(i, element.IMP_SEQ_NO, element.fileLevel);
                        }
                        i++;
                    });
                }
                if (file_level == '18') {
                    increaseFormNode3();
                }
            }
            increaseFormNode('fileLevel', 'fileLevel', file_level); //文件等级

            //征信授权的时候查看另外的页面，该页面支持把流水下的所有批次全部显示
            if (file_level == '36') {
                url = url + '?viewPage=viewPage';
            } else if (file_level == '18') {
                url = url.replace('SunIASRequestServlet.do', 'CreditImgRequestServlet.do');
            }
            document.forms[0].setAttribute('action', url);

            setTimeout(function () {
                document.forms[0].submit();
                console.log(document.forms[0]);
            })
        })
    </script>
</body>

</html>